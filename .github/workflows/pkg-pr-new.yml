name: pkg-pr-new
on: 
  pull_request_target:
    paths: 
      - 'packages/**'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read  

    steps:
    - name: Checkout code repository
      uses: actions/checkout@v4

    - name: Determine changes in packages
      uses: dorny/paths-filter@v3
      id: changes
      with: 
        filters: |
          base:
            - 'packages/base-ui/**'  
          accounts:
            - 'packages/accounts/**'  
          forms:
            - 'packages/forms/**'  
          pay:
            - 'packages/pay/**'
    
    - name: Create package list
      id: package_list
      if: steps.changes.outputs.base == 'true' || steps.changes.outputs.accounts == 'true' || steps.changes.outputs.forms == 'true' || steps.changes.outputs.pay == 'true'
      run: |
        PACKAGE_LIST=""
        if [ "${{ steps.changes.outputs.base }}" == "true" ]; then
          PACKAGE_LIST+="./packages/base-ui "
        fi
        if [ "${{ steps.changes.outputs.accounts }}" == "true" ]; then
          PACKAGE_LIST+="./packages/accounts "
        fi
        if [ "${{ steps.changes.outputs.forms }}" == "true" ]; then
          PACKAGE_LIST+="./packages/forms "
        fi
        if [ "${{ steps.changes.outputs.pay }}" == "true" ]; then
          PACKAGE_LIST+="./packages/pay "
        fi
        echo "PACKAGES_TO_PUBLISH=${PACKAGE_LIST}"
        echo "list=${PACKAGE_LIST}" >> $GITHUB_OUTPUT

    - name: Setup pnpm
      if: steps.package_list.outputs.list != ''
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Setup node.js
      if: steps.package_list.outputs.list != ''
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'pnpm'
    
    - name: Install dependencies
      if: steps.package_list.outputs.list != ''
      run: pnpm install

    - name: Publish Changed Packages
      if: steps.package_list.outputs.list != ''
      run: npx pkg-pr-new publish ${{ steps.package_list.outputs.list }} --compact --json output.json --comment=off
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}

    - name: Post or update custom comment
      if: steps.package_list.outputs.list != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GH_PAT }}
        script: |
          const fs = require('fs');
          const output = JSON.parse(fs.readFileSync('output.json', 'utf8'));

          const packages = output.packages
              .map((p) => `- ${p.name}:\n    \`\`\`\n    pnpm add ${p.url}\n    \`\`\``)
              .join('\n\n');

          const sha =
              context.event_name === 'pull_request'
                  ? context.payload.pull_request.head.sha
                  : context.payload.after;
          const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${sha}`;
          
          const body = `## Preview Ready!

          ### Published Packages:

          ${packages}

          [View Commit](${commitUrl})`;
          
          const botCommentIdentifier = '## Preview Ready!';

          async function findBotComment(issueNumber) {
            if (!issueNumber) return null;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            return comments.data.find((comment) =>
              comment.body.includes(botCommentIdentifier)
            );
          }

          async function createOrUpdateComment(issueNumber) {
            if (!issueNumber) {
              console.log('No issue number provided. Cannot post or update comment.');
              return;
            }

            const existingComment = await findBotComment(issueNumber);
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }
          }

          async function logPublishInfo() {
            console.log('\n' + '='.repeat(50));
            console.log('Publish Information');
            console.log('='.repeat(50));
            console.log('\nPublished Packages:');
            console.log(packages);
            console.log('\nTemplates:');
            console.log(templates);
            console.log(`\nCommit URL: ${commitUrl}`);
            console.log('\n' + '='.repeat(50));
          }

          if (context.eventName === 'pull_request') {
            if (context.issue.number) {
              await createOrUpdateComment(context.issue.number);
            }
          } else if (context.eventName === 'push') {
            const pullRequests = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.ref.replace(
                'refs/heads/',
                ''
              )}`,
            });

            if (pullRequests.data.length > 0) {
              await createOrUpdateComment(pullRequests.data[0].number);
            } else {
              console.log(
                'No open pull request found for this push. Logging publish information to console:'
              );
              await logPublishInfo();
            }
          }